{"version":3,"sources":["../../src/package/ZipService.js"],"names":["fs","require","path","archiver","MAX_LAYER_MB_SIZE","AbstractService","ZipService","package","zipFileName","plugin","getPathZipFileName","layersDir","join","process","cwd","settings","compileDir","Promise","resolve","reject","oldCwd","output","createWriteStream","zip","create","on","MB","pointer","toFixed","log","Error","err","chdir","pipe","directory","finalize","then","module","exports"],"mappings":";;AAAA,MAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB;;AACA,MAAMC,IAAI,GAAGD,OAAO,CAAC,MAAD,CAApB;;AACA,MAAME,QAAQ,GAAGF,OAAO,CAAC,UAAD,CAAxB;;AAEA,MAAMG,iBAAiB,GAAG,GAA1B;;AAEA,MAAMC,eAAe,GAAGJ,OAAO,CAAC,oBAAD,CAA/B;;AAEA,MAAMK,UAAN,SAAyBD,eAAzB,CAAyC;AACvCE,EAAAA,OAAO,GAAG;AACR,UAAMC,WAAW,GAAG,KAAKC,MAAL,CAAYC,kBAAZ,EAApB;AACA,UAAMC,SAAS,GAAGT,IAAI,CAACU,IAAL,CAAUC,OAAO,CAACC,GAAR,EAAV,EAAyB,KAAKL,MAAL,CAAYM,QAAZ,CAAqBC,UAA9C,CAAlB;AAEA,WAAO,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,YAAMC,MAAM,GAAGP,OAAO,CAACC,GAAR,EAAf;AACA,YAAMO,MAAM,GAAGrB,EAAE,CAACsB,iBAAH,CAAqBd,WAArB,CAAf;AACA,YAAMe,GAAG,GAAGpB,QAAQ,CAACqB,MAAT,CAAgB,KAAhB,CAAZ;AAEAH,MAAAA,MAAM,CAACI,EAAP,CAAU,OAAV,EAAmB,MAAM;AACvB,cAAMC,EAAE,GAAG,CAACH,GAAG,CAACI,OAAJ,KAAgB,IAAhB,GAAuB,IAAxB,EAA8BC,OAA9B,CAAsC,CAAtC,CAAX;;AAEA,YAAIF,EAAE,GAAGtB,iBAAT,EAA4B;AAC1B,eAAKK,MAAL,CAAYoB,GAAZ,CAAgB,gBAAhB;AACA,gBAAM,IAAIC,KAAJ,CACJ,kFACA,uFAFI,CAAN;AAID;;AAED,aAAKrB,MAAL,CAAYoB,GAAZ,CAAiB,yBAAwBrB,WAAY,KAAIkB,EAAG,MAA5D;AACAR,QAAAA,OAAO;AACR,OAbD;AAeAK,MAAAA,GAAG,CAACE,EAAJ,CAAO,OAAP,EAAiBM,GAAD,IAAS;AACvBZ,QAAAA,MAAM,CAACY,GAAD,CAAN;AACAlB,QAAAA,OAAO,CAACmB,KAAR,CAAcZ,MAAd;AACD,OAHD;AAKAP,MAAAA,OAAO,CAACmB,KAAR,CAAcrB,SAAd;AAEAY,MAAAA,GAAG,CAACU,IAAJ,CAASZ,MAAT;AAEAE,MAAAA,GAAG,CAACW,SAAJ,CAAc,QAAd,EAAwB,KAAxB;AAEAX,MAAAA,GAAG,CAACY,QAAJ,GACGC,IADH,CACQ,MAAM;AACVvB,QAAAA,OAAO,CAACmB,KAAR,CAAcZ,MAAd;AACD,OAHH;AAID,KAnCM,CAAP;AAoCD;;AAzCsC;;AA4CzCiB,MAAM,CAACC,OAAP,GAAiBhC,UAAjB","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst archiver = require('archiver');\n\nconst MAX_LAYER_MB_SIZE = 250;\n\nconst AbstractService = require('../AbstractService');\n\nclass ZipService extends AbstractService {\n  package() {\n    const zipFileName = this.plugin.getPathZipFileName();\n    const layersDir = path.join(process.cwd(), this.plugin.settings.compileDir);\n\n    return new Promise((resolve, reject) => {\n      const oldCwd = process.cwd();\n      const output = fs.createWriteStream(zipFileName);\n      const zip = archiver.create('zip');\n\n      output.on('close', () => {\n        const MB = (zip.pointer() / 1024 / 1024).toFixed(1);\n\n        if (MB > MAX_LAYER_MB_SIZE) {\n          this.plugin.log('Package error!');\n          throw new Error(\n            'Layers can\\'t exceed the unzipped deployment package size limit of 250 MB! \\n'\n          + 'Read more: https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html\\n\\n'\n          );\n        }\n\n        this.plugin.log(`Created layer package ${zipFileName} (${MB} MB)`);\n        resolve();\n      });\n\n      zip.on('error', (err) => {\n        reject(err);\n        process.chdir(oldCwd);\n      });\n\n      process.chdir(layersDir);\n\n      zip.pipe(output);\n\n      zip.directory('layers', false);\n\n      zip.finalize()\n        .then(() => {\n          process.chdir(oldCwd);\n        });\n    });\n  }\n}\n\nmodule.exports = ZipService;\n"],"file":"ZipService.js"}