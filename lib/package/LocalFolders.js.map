{"version":3,"sources":["../../src/package/LocalFolders.js"],"names":["path","require","fsExtra","mkdirp","hashElement","AbstractService","LocalFolders","init","layersPackageDir","getLayerPackageDir","sync","getManifestName","hashName","toLowerCase","getHash","settings","plugin","localDir","options","folders","files","hasFoldersChanged","then","hash","manifest","name","bucketService","getFile","remoteManifest","JSON","stringify","copyFolders","to","join","libraryFolder","from","resolve","copy","putFile","module","exports"],"mappings":";;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAC,MAAD,CAApB;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAC,QAAD,CAAtB;;AACA,MAAM;AAAEG,EAAAA;AAAF,IAAkBH,OAAO,CAAC,aAAD,CAA/B;;AAEA,MAAMI,eAAe,GAAGJ,OAAO,CAAC,oBAAD,CAA/B;;AAEA,MAAMK,YAAN,SAA2BD,eAA3B,CAA2C;AACzCE,EAAAA,IAAI,GAAG;AACL,SAAKC,gBAAL,GAAwB,KAAKC,kBAAL,EAAxB;AACA,WAAON,MAAM,CAACO,IAAP,CAAY,KAAKF,gBAAjB,CAAP;AACD;;AAEDG,EAAAA,eAAe,CAACC,QAAD,EAAW;AACxB,WAAQ,8BAA6BA,QAAQ,CAACC,WAAT,EAAuB,OAA5D;AACD;;AAED,QAAMC,OAAN,GAAgB;AACd,UAAM;AAAEC,MAAAA;AAAF,QAAe,KAAKC,MAA1B;;AAEA,QAAI,CAACD,QAAQ,CAACE,QAAd,EAAwB;AACtB;AACD;;AAED,UAAMC,OAAO,GAAG;AACdC,MAAAA,OAAO,EAAEJ,QAAQ,CAACE,QAAT,CAAkBE,OADb;AAEdC,MAAAA,KAAK,EAAEL,QAAQ,CAACE,QAAT,CAAkBG;AAFX,KAAhB;AAKA,WAAOhB,WAAW,CAACW,QAAQ,CAACE,QAAT,CAAkBjB,IAAnB,EAAyBkB,OAAzB,CAAlB;AACD;;AAED,QAAMG,iBAAN,GAA0B;AACxB,WAAO,KAAKP,OAAL,GAAeQ,IAAf,CAAqBC,IAAD,IAAU;AACnC,YAAMC,QAAQ,GAAG,KAAKb,eAAL,CAAqBY,IAAI,CAACE,IAA1B,CAAjB;AACA,aAAO,KAAKT,MAAL,CAAYU,aAAZ,CAA0BC,OAA1B,CAAkCH,QAAlC,EAA4CF,IAA5C,CAAiDM,cAAc,IAAI;AACxE,YAAIA,cAAc,KAAKC,IAAI,CAACC,SAAL,CAAeP,IAAf,CAAvB,EAA6C;AAC3C;AACA,iBAAO,KAAP;AACD;;AACD,eAAO,IAAP;AACD,OANM,CAAP;AAOD,KATM,CAAP;AAUD;;AAED,QAAMQ,WAAN,GAAoB;AAClB,UAAM;AAAEhB,MAAAA;AAAF,QAAe,KAAKC,MAA1B;;AAEA,QAAI,CAACD,QAAQ,CAACE,QAAd,EAAwB;AACtB;AACD;;AAED,UAAM,KAAKH,OAAL,GACHQ,IADG,CACGC,IAAD,IAAU;AACd,YAAMC,QAAQ,GAAG,KAAKb,eAAL,CAAqBY,IAAI,CAACE,IAA1B,CAAjB;AACA,YAAMO,EAAE,GAAGhC,IAAI,CAACiC,IAAL,CAAU,KAAKzB,gBAAf,EAAiCO,QAAQ,CAACmB,aAA1C,EAAyDnB,QAAQ,CAACE,QAAT,CAAkBQ,IAA3E,CAAX;AACA,YAAMU,IAAI,GAAGnC,IAAI,CAACoC,OAAL,CAAarB,QAAQ,CAACE,QAAT,CAAkBjB,IAA/B,CAAb;AAEA,aAAOE,OAAO,CAACmC,IAAR,CAAaF,IAAb,EAAmBH,EAAnB,EAAuBV,IAAvB,CAA4B,MAAM;AACvC,eAAO,KAAKN,MAAL,CAAYU,aAAZ,CAA0BY,OAA1B,CAAkCd,QAAlC,EAA4CK,IAAI,CAACC,SAAL,CAAeP,IAAf,CAA5C,CAAP;AACD,OAFM,CAAP;AAGD,KATG,CAAN;AAUD;;AAvDwC;;AA0D3CgB,MAAM,CAACC,OAAP,GAAiBlC,YAAjB","sourcesContent":["const path = require('path');\nconst fsExtra = require('fs-extra');\nconst mkdirp = require('mkdirp');\nconst { hashElement } = require('folder-hash');\n\nconst AbstractService = require('../AbstractService');\n\nclass LocalFolders extends AbstractService {\n  init() {\n    this.layersPackageDir = this.getLayerPackageDir();\n    return mkdirp.sync(this.layersPackageDir);\n  }\n\n  getManifestName(hashName) {\n    return `__meta__/manifest-localdir-${hashName.toLowerCase()}.json`;\n  }\n\n  async getHash() {\n    const { settings } = this.plugin;\n\n    if (!settings.localDir) {\n      return;\n    }\n\n    const options = {\n      folders: settings.localDir.folders,\n      files: settings.localDir.files\n    };\n\n    return hashElement(settings.localDir.path, options);\n  }\n\n  async hasFoldersChanged() {\n    return this.getHash().then((hash) => {\n      const manifest = this.getManifestName(hash.name);\n      return this.plugin.bucketService.getFile(manifest).then(remoteManifest => {\n        if (remoteManifest === JSON.stringify(hash)) {\n          // not changed\n          return false;\n        }\n        return true;\n      });\n    });\n  }\n\n  async copyFolders() {\n    const { settings } = this.plugin;\n\n    if (!settings.localDir) {\n      return;\n    }\n\n    await this.getHash()\n      .then((hash) => {\n        const manifest = this.getManifestName(hash.name);\n        const to = path.join(this.layersPackageDir, settings.libraryFolder, settings.localDir.name);\n        const from = path.resolve(settings.localDir.path);\n\n        return fsExtra.copy(from, to).then(() => {\n          return this.plugin.bucketService.putFile(manifest, JSON.stringify(hash));\n        });\n      });\n  }\n}\n\nmodule.exports = LocalFolders;\n"],"file":"LocalFolders.js"}